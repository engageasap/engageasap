<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM</title>
    <!-- Material Design Theming -->
    <!-- <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script> -->
    <link rel="manifest" href="/manifest.json">
</head>

<body>
    <div>
        Push Demo TEST
    </div>
    <script src="https://www.gstatic.com/firebasejs/6.1.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.1.1/firebase-messaging.js"></script>

    <script>
        const PUSH_SERVICE_CLIENT_ID = "1234567890";
        var firebaseConfig = {
            apiKey: "AIzaSyDwQ1l_xlv152z3zsXoCEqVrdy32ZkGtOQ",
            authDomain: "pushservice-de9e2.firebaseapp.com",
            databaseURL: "https://pushservice-de9e2.firebaseio.com",
            projectId: "pushservice-de9e2",
            storageBucket: "pushservice-de9e2.appspot.com",
            messagingSenderId: "53707849923",
            appId: "1:53707849923:web:fd85f9eb2ea64d1c"
        };
        firebase.initializeApp(firebaseConfig);
        const messaging = firebase.messaging();
        messaging.usePublicVapidKey('BH_ct5AA7O07SFVmUTo8Zmv1loWKDSDP--pcQMeFaN0an8-qg5E8pp4o9WwDQelRUKmJ-SgtTNRsZWd625S9G_Y');

        navigator.serviceWorker.register('sw.js')
            .then((registration) => {
                messaging.useServiceWorker(registration);
                function requestPermission() {
                    Notification.requestPermission().then(function (permission) {
                        if (permission === 'granted') {
                            messaging.getToken().then(function (currentToken) {
                                if (currentToken) {
                                    sendTokenToServer({
                                        clientId: PUSH_SERVICE_CLIENT_ID,
                                        token: currentToken
                                    })
                                } else {
                                    console.log('No Instance ID token available. Request permission to generate one.');
                                }
                            }).catch(function (err) {
                                console.log('An error occurred while retrieving token. ', err);
                            });
                        } else {
                            console.log('Unable to get permission to notify.');
                        }
                    });
                }

                messaging.onTokenRefresh(function () {
                    messaging.getToken().then(function (refreshedToken) {
                        sendTokenToServer({
                            clientId: PUSH_SERVICE_CLIENT_ID,
                            token: refreshedToken
                        })
                    }).catch(function (err) {
                        console.log('Unable to retrieve refreshed token ', err);
                    });
                });

                messaging.onMessage(function (payload) {
                    console.log('Message received. ', payload);
                });

                function sendTokenToServer({ token, clientId }) {
                    const url = 'http://192.168.100.16:9000/insertToken';

                    if (!token || !clientId || !url) return;
                    console.log("resquest sent for token", token)
                    fetch(url, {
                        headers: {
                            'Content-type': 'application/json'
                        },
                        method: 'POST',
                        body: JSON.stringify({
                            tokenId: token,
                            userId: clientId
                        })
                    })
                }

                requestPermission()
            });
    </script>
</body>

</html>